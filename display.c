#include <inttypes.h>
#include <string.h>
#include <avr/io.h>
#include <util/delay.h>
#include <avr/pgmspace.h>
#include "display.h"

#define DISP_SCE BIT(2)
#define DISP_SDC BIT(3)
#define DISP_DIN BIT(4)
#define DISP_CLK BIT(5)
#define DISP_RESET BIT(1)
#define DISP_PORT PORTC


#define DISP_COMMAND 0
#define DISP_DATA 1

#define DISP_XSIZE 84
#define DISP_YSIZE 6


#define DISP_POWERDOWN 0x04
#define DISP_ENTRYMODE 0x02
#define DISP_EXTENDEDINSTRUCTION 0x01

#define DISP_DISPLAYBLANK 0x0
#define DISP_DISPLAYNORMAL 0x4
#define DISP_DISPLAYALLON 0x1
#define DISP_DISPLAYINVERTED 0x5

// H = 0
#define DISP_FUNCTIONSET 0x20
#define DISP_DISPLAYCONTROL 0x08
#define DISP_SETYADDR 0x40
#define DISP_SETXADDR 0x80

// H = 1
#define DISP_SETTEMP 0x04
#define DISP_SETBIAS 0x10
#define DISP_SETVOP 0x80



#define BIT_GET(p,m) ((p) & (m))
#define BIT_SET(p,m) ((p) |= (m))
#define BIT_CLR(p,m) ((p) &= ~(m))
#define BIT_FLIP(p,m) ((p) ^= (m))
#define BIT_WRITE(c,p,m) (c ? BIT_SET(p,m) : BIT_CLR(p,m))
#define BIT(x) (0x01 << (x))
#define LONGBIT(x) ((unsigned long)0x00000001 << (x))


uint8_t data[DISP_XSIZE*DISP_YSIZE];

PROGMEM const char font[] = {
0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x5e,0x00,0x00,
0x00,0x0e,0x00,0x0e,0x00,
0x14,0x7f,0x14,0x7f,0x14,
0x04,0x2a,0x7f,0x2a,0x10,
0x00,0x16,0x08,0x34,0x00,
0x36,0x49,0x36,0x40,0x00,
0x00,0x00,0x0e,0x00,0x00,
0x00,0x3c,0x42,0x00,0x00,
0x00,0x42,0x3c,0x00,0x00,
0x54,0x38,0x38,0x54,0x00,
0x10,0x10,0x7c,0x10,0x10,
0x00,0x80,0x60,0x20,0x00,
0x10,0x10,0x10,0x10,0x00,
0x00,0x40,0xe0,0x40,0x00,
0x60,0x10,0x08,0x06,0x00,
0x00,0x3c,0x42,0x3c,0x00,
0x00,0x44,0x7e,0x40,0x00,
0x64,0x52,0x52,0x4c,0x00,
0x22,0x4a,0x4e,0x32,0x00,
0x18,0x14,0x7e,0x10,0x00,
0x2e,0x4a,0x4a,0x32,0x00,
0x3c,0x4a,0x4a,0x30,0x00,
0x02,0x62,0x1a,0x06,0x00,
0x34,0x4a,0x4a,0x34,0x00,
0x0c,0x52,0x52,0x3c,0x00,
0x00,0x6c,0x6c,0x00,0x00,
0x00,0x80,0x6c,0x2c,0x00,
0x00,0x18,0x24,0x42,0x00,
0x28,0x28,0x28,0x28,0x00,
0x00,0x42,0x24,0x18,0x00,
0x00,0x04,0x52,0x0c,0x00,
0x3c,0x42,0x99,0xa5,0x1e,
0x7c,0x12,0x12,0x7c,0x00,
0x7e,0x4a,0x4a,0x34,0x00,
0x3c,0x42,0x42,0x24,0x00,
0x7e,0x42,0x42,0x3c,0x00,
0x7e,0x4a,0x4a,0x42,0x00,
0x7e,0x0a,0x0a,0x02,0x00,
0x3c,0x42,0x52,0x34,0x00,
0x7e,0x08,0x08,0x7e,0x00,
0x00,0x42,0x7e,0x42,0x00,
0x20,0x42,0x3e,0x02,0x00,
0x7e,0x08,0x34,0x42,0x00,
0x7e,0x40,0x40,0x40,0x00,
0x7e,0x0c,0x0c,0x7e,0x00,
0x7e,0x0c,0x38,0x7e,0x00,
0x3c,0x42,0x42,0x3c,0x00,
0x7e,0x12,0x12,0x0c,0x00,
0x3c,0x52,0x62,0xbc,0x00,
0x7e,0x12,0x12,0x6c,0x00,
0x24,0x4a,0x52,0x24,0x00,
0x00,0x02,0x7e,0x02,0x00,
0x3e,0x40,0x40,0x3e,0x00,
0x1e,0x60,0x60,0x1e,0x00,
0x7e,0x30,0x30,0x7e,0x00,
0x66,0x18,0x18,0x66,0x00,
0x06,0x08,0x70,0x08,0x06,
0x62,0x52,0x4a,0x46,0x00,
0x00,0x7e,0x42,0x42,0x00,
0x06,0x08,0x10,0x60,0x00,
0x00,0x42,0x42,0x7e,0x00,
0x00,0x04,0x02,0x04,0x00,
0x80,0x80,0x80,0x80,0x00,
0x00,0x02,0x04,0x00,0x00,
0x30,0x48,0x48,0x78,0x00,
0x7e,0x48,0x48,0x30,0x00,
0x00,0x30,0x48,0x48,0x00,
0x30,0x48,0x48,0x7e,0x00,
0x30,0x68,0x58,0x10,0x00,
0x10,0x7c,0x12,0x04,0x00,
0x10,0xa8,0xa8,0x70,0x00,
0x7e,0x08,0x08,0x70,0x00,
0x00,0x48,0x7a,0x40,0x00,
0x00,0x40,0x80,0x7a,0x00,
0x7e,0x10,0x10,0x68,0x00,
0x00,0x42,0x7e,0x40,0x00,
0x78,0x08,0x70,0x08,0x70,
0x78,0x08,0x08,0x70,0x00,
0x30,0x48,0x48,0x30,0x00,
0xf8,0x28,0x28,0x10,0x00,
0x10,0x28,0x28,0xf8,0x00,
0x78,0x10,0x08,0x10,0x00,
0x00,0x50,0x58,0x28,0x00,
0x08,0x3e,0x48,0x20,0x00,
0x38,0x40,0x40,0x78,0x00,
0x00,0x38,0x40,0x38,0x00,
0x38,0x40,0x30,0x40,0x38,
0x48,0x30,0x30,0x48,0x00,
0x58,0xa0,0xa0,0x78,0x00,
0x48,0x68,0x58,0x48,0x00,
0x08,0x2a,0x55,0x41,0x00,
0x00,0x00,0x7e,0x00,0x00,
0x41,0x55,0x2a,0x08,0x00,
0x04,0x02,0x04,0x02,0x00,
};

#define FONT_CHARWIDTH 5
#define FONT_STARTCHAR 0x20
#define FONT_ENDCHAR 0x7E

PROGMEM const char font2[] = {
0x78,0x30,0x48,0x30,0x00,
0x30,0x48,0x48,0x78,0x00,
0x3c,0x4a,0x4a,0x31,0x00,
0x78,0x40,0x40,0xf8,0x00,
0xe0,0x58,0x48,0xf8,0x00,
0x30,0x68,0x58,0x10,0x00,
0x00,0x78,0xce,0x78,0x00,
0x00,0x78,0x08,0x08,0x00,
0x48,0x30,0x30,0x48,0x00,
0x78,0x20,0x10,0x78,0x00,
0x78,0x22,0x12,0x78,0x00,
0x78,0x10,0x30,0x48,0x00,
0x40,0x30,0x08,0x78,0x00,
0x78,0x10,0x60,0x10,0x78,
0x78,0x10,0x10,0x78,0x00,
0x30,0x48,0x48,0x30,0x00,
0x78,0x08,0x08,0x78,0x00,
0x00,0x50,0x28,0x78,0x00,
0xf8,0x48,0x48,0x30,0x00,
0x00,0x30,0x48,0x48,0x00,
0x00,0x08,0x78,0x08,0x00,
0x18,0xa0,0x40,0x38,0x00,
0x68,0x10,0x78,0x10,0x68,
0x78,0x58,0x58,0x20,0x00,
0x78,0x50,0x50,0x20,0x00,
0x78,0x50,0x20,0x78,0x00,
0x00,0x48,0x58,0x38,0x00,
0x78,0x40,0x78,0x40,0x78,
0x00,0x48,0x58,0x30,0x00,
0x78,0x40,0x78,0x40,0xf8,
0x18,0x20,0x20,0x78,0x00,
0x08,0x78,0x50,0x20,0x00,
0x7e,0x08,0x3c,0x42,0x3c,
0x7c,0x12,0x12,0x7c,0x00,
0x7e,0x4a,0x4a,0x30,0x00,
0x7e,0x40,0x7e,0xc0,0x00,
0xfc,0x42,0x7e,0xc0,0x00,
0x7e,0x4a,0x4a,0x42,0x00,
0x18,0x24,0x7e,0x24,0x18,
0x7e,0x02,0x02,0x06,0x00,
0x00,0x66,0x18,0x66,0x00,
0x7e,0x10,0x08,0x7e,0x00,
0x7e,0x11,0x09,0x7e,0x00,
0x7e,0x08,0x14,0x62,0x00,
0x40,0x3c,0x02,0x7e,0x00,
0x7e,0x0c,0x0c,0x7e,0x00,
0x7e,0x08,0x08,0x7e,0x00,
0x3c,0x42,0x42,0x3c,0x00,
0x7e,0x02,0x02,0x7e,0x00,
0x6c,0x12,0x12,0x7e,0x00,
0x7e,0x12,0x12,0x0c,0x00,
0x3c,0x42,0x42,0x24,0x00,
0x00,0x02,0x7e,0x02,0x00,
0x4e,0x50,0x50,0x3e,0x00,
0x76,0x08,0x7e,0x08,0x76,
0x7e,0x4a,0x4a,0x34,0x00,
0x00,0x7e,0x48,0x30,0x00,
0x7e,0x48,0x30,0x00,0x7e,
0x24,0x42,0x4a,0x34,0x00,
0x7e,0x40,0x7e,0x40,0x7e,
0x42,0x4a,0x4a,0x3c,0x00,
0x7e,0x40,0x7e,0x40,0xfe,
0x00,0x0e,0x10,0x7e,0x00,
0x02,0x02,0x7e,0x48,0x30
};
#define FONT2_CHARWIDTH 5
#define FONT2_STARTCHAR 0xC0
#define FONT2_ENDCHAR 0xFF

void send_byte(unsigned char db, unsigned char dc){
  unsigned char bit;
  BIT_WRITE(dc,DISP_PORT,DISP_SDC);
  BIT_CLR(DISP_PORT,DISP_SCE);
  for(bit = 0x80; bit; bit >>=1){
    BIT_CLR(DISP_PORT,DISP_CLK);
    if(db & bit){
      BIT_SET(DISP_PORT,DISP_DIN);
    }else{
      BIT_CLR(DISP_PORT,DISP_DIN);
    }
    _delay_us(10);
    BIT_SET(DISP_PORT,DISP_CLK);
    _delay_us(10);
  }
} 

  
void init_display(uint8_t contrast){
  BIT_CLR(DISP_PORT,DISP_RESET);
  _delay_ms(500);
  BIT_SET(DISP_PORT,DISP_RESET);
  _delay_ms(5);
  if(contrast>0x7f){
    contrast=0x7f;
  }
  send_byte(DISP_FUNCTIONSET | DISP_EXTENDEDINSTRUCTION,DISP_COMMAND);
  send_byte(DISP_SETVOP | contrast,DISP_COMMAND);
  send_byte(DISP_SETBIAS | 0x04,DISP_COMMAND);
  send_byte(DISP_FUNCTIONSET,DISP_COMMAND);
  send_byte(DISP_DISPLAYCONTROL | DISP_DISPLAYNORMAL,DISP_COMMAND);

  send_byte(DISP_SETYADDR, DISP_COMMAND);
  send_byte(DISP_SETXADDR, DISP_COMMAND);
  memset(data,0,sizeof(data));
}

void set_contrast(uint8_t vop, uint8_t bias){
  if(vop > 0x7f) vop = 0x7f;
  if(bias > 0x07) bias =0x04;
  send_byte(DISP_FUNCTIONSET | DISP_EXTENDEDINSTRUCTION,DISP_COMMAND);
  send_byte(DISP_SETVOP | vop,DISP_COMMAND);
  send_byte(DISP_SETBIAS | bias,DISP_COMMAND);
  send_byte(DISP_FUNCTIONSET,DISP_COMMAND);
}


void upload_box(uint8_t x, uint8_t y, uint8_t dx, uint8_t dy){ 
  uint8_t i,j;
  send_byte(DISP_SETYADDR |y , DISP_COMMAND);
  for(j=y; (j<y+dy && j<DISP_YSIZE); j++){
    send_byte(DISP_SETXADDR |x , DISP_COMMAND);
    for(i=x;i<x+dx;i++){
      send_byte(data[j*DISP_XSIZE+i], DISP_DATA);
    }
  }
}  

void putsxy(uint8_t x, uint8_t y, unsigned char *msg){
  uint8_t curx;
  curx=x;
  while(*msg){
    if(*msg>=FONT_STARTCHAR && *msg<=FONT_ENDCHAR){
      for(uint8_t i=0; i< FONT_CHARWIDTH; i++){
        data[y*DISP_XSIZE+curx]=pgm_read_byte(&font[(*msg-FONT_STARTCHAR)*FONT_CHARWIDTH+i]);
        curx++;
        if(curx>DISP_XSIZE) break;
      }
      if(curx>DISP_XSIZE) break;
    }
    if(*msg>=FONT2_STARTCHAR && *msg<=FONT2_ENDCHAR){
      for(uint8_t i=0; i< FONT2_CHARWIDTH; i++){
        data[y*DISP_XSIZE+curx]=pgm_read_byte(&font2[(*msg-FONT2_STARTCHAR)*FONT2_CHARWIDTH+i]);
        curx++;
        if(curx>DISP_XSIZE) break;
      }
      if(curx>DISP_XSIZE) break;
    }
    msg++;
  }
  upload_box(x,y,curx-x+1,1);
  BIT_SET(DISP_PORT,DISP_SCE);
}
